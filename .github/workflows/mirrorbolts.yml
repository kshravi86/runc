name: Mirror Homebrew Bottles
on:
  workflow_dispatch:

jobs:
  fetch-bottles:
    # Use Ventura Intel runner to mirror x86_64 bottles.
    runs-on: macos-13
    steps:
      - name: Show Homebrew info
        run: |
          brew config
          brew update-reset

      - name: Build and bottle formulae
        run: |
          set -euo pipefail
          mkdir -p bottles
          FORMULAS=(openssl@3 readline icu4c sqlite gmp mpdecimal pkg-config libffi)
          for formula_hdr in "${FORMULAS[@]}"; do
            formula="${formula_hdr%@*}"
            version_suffix="${formula_hdr#*@}"
            full_name="$formula"
            [[ "$formula_hdr" == *"@"* ]] && full_name="$formula@$version_suffix"
            # Uninstall only if safe; otherwise reinstall with ignore-dependencies.
            if brew list --versions "$full_name" >/dev/null; then
              if [[ "$full_name" == openssl@3 ]]; then
                brew reinstall --build-bottle --ignore-dependencies "$full_name"
              else
                brew uninstall --force "$full_name"
                brew install --build-bottle "$full_name"
              fi
            else
              brew install --build-bottle "$full_name"
            fi
            brew bottle --force-core-tap "$full_name"
            # Move resulting bottle(s) into our bottles directory.
            mv ./*.bottle*.tar.gz bottles/ || true
            mv ./*.bottle*.json bottles/ || true
          done
          CACHE_DIR="$(brew --cache)"
          find "$CACHE_DIR" -name "*.bottle.tar.gz" -maxdepth 1 -print -exec cp {} bottles/ \;
          # Keep JSON checksums if present
          find "$CACHE_DIR" -name "*.bottle.json" -maxdepth 1 -print -exec cp {} bottles/ \;

      - name: List bottled files
        run: ls -lh bottles

      - name: Upload bottles as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottles
          path: bottles
          if-no-files-found: error
