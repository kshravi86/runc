name: Mirror Homebrew Bottles
on:
  workflow_dispatch:

jobs:
  fetch-bottles:
    # Use Ventura Intel runner to mirror x86_64 bottles.
    runs-on: macos-13
    steps:
      - name: Show Homebrew info
        run: |
          brew config
          brew update-reset

      - name: Fetch bottles for each formula
        run: |
          set -euo pipefail
          mkdir -p bottles
          FORMULAS=(openssl@3 readline icu4c sqlite gmp mpdecimal pkg-config libffi)
          # Simulate Ventura so Homebrew fetches Intel bottles even on Tier-3 hosts
          HOMEBREW_SIMULATE_SYSTEM=ventura \
            brew fetch --force --bottle --bottle-tag=ventura "${FORMULAS[@]}"
          # Copy everything fetched to a clean folder for upload
          CACHE_DIR="$(brew --cache)"
          find "$CACHE_DIR" -name "*.bottle.tar.gz" -maxdepth 1 -print -exec cp {} bottles/ \;
          # Keep JSON checksums if present
          find "$CACHE_DIR" -name "*.bottle.json" -maxdepth 1 -print -exec cp {} bottles/ \;

      - name: List bottled files
        run: ls -lh bottles

      - name: Upload bottles as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottles
          path: bottles
          if-no-files-found: error
