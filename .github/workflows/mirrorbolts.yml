name: Mirror Homebrew Bottles
on:
  workflow_dispatch:

jobs:
  fetch-bottles:
    # Use Ventura Intel runner to mirror x86_64 bottles.
    runs-on: macos-13
    steps:
      - name: Show Homebrew info
        run: |
          brew config
          brew update-reset

      - name: Build and bottle formulae
        run: |
          set -euo pipefail
          mkdir -p bottles
          FORMULAS=(openssl@3 readline icu4c sqlite gmp mpdecimal pkg-config libffi)
          for formula in "${FORMULAS[@]}"; do
            name="$formula"
            if brew list --versions "$name" >/dev/null; then
              if [[ "$name" == openssl@3 ]]; then
                brew install --build-bottle "$name"
              else
                brew uninstall --force "$name"
                brew install --build-bottle "$name"
              fi
            else
              brew install --build-bottle "$name"
            fi
            brew bottle --force-core-tap "$name"
            # Move resulting bottle(s) into our bottles directory.
            mv ./*.bottle*.tar.gz bottles/ || true
            mv ./*.bottle*.json bottles/ || true
          done
          CACHE_DIR="$(brew --cache)"
          find "$CACHE_DIR" -name "*.bottle.tar.gz" -maxdepth 1 -print -exec cp {} bottles/ \;
          # Keep JSON checksums if present
          find "$CACHE_DIR" -name "*.bottle.json" -maxdepth 1 -print -exec cp {} bottles/ \;

      - name: List bottled files
        run: ls -lh bottles

      - name: Upload bottles as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottles
          path: bottles
          if-no-files-found: error
