name: Run-C Screenshots (iPhone)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Simulator device name (iPhone)"
        required: false
        default: "iPhone 15 Pro Max"

jobs:
  simshot:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: Build app for Simulator (Debug)
        run: |
          set -euo pipefail
          DEVICE_NAME='${{ inputs.device }}'
          BUILD_CACHE="$PWD/.ci-build"
          DERIVED_DATA="$BUILD_CACHE/DerivedData"
          SPM_CACHE="$BUILD_CACHE/SPM"
          rm -rf "$DERIVED_DATA"
          mkdir -p "$DERIVED_DATA" "$SPM_CACHE"
          xcodebuild -resolvePackageDependencies -project Run-C.xcodeproj -scheme "Run-C" -clonedSourcePackagesDirPath "$SPM_CACHE"
          xcodebuild -project Run-C.xcodeproj \
            -scheme "Run-C" \
            -configuration Debug \
            -destination "platform=iOS Simulator,name=${DEVICE_NAME},OS=latest" \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=YES ARCHS=arm64 EXCLUDED_ARCHS=arm64e \
            IPHONEOS_DEPLOYMENT_TARGET=17.0 \
            build | xcpretty
          APP_DIR=""
          SEARCH_BASE="$DERIVED_DATA/Build/Products"
          if [ -d "$SEARCH_BASE" ]; then
            APP_DIR=$(find "$SEARCH_BASE" -type d -path "*-iphonesimulator/*.app" -print -quit || true)
            if [ -z "$APP_DIR" ]; then
              APP_DIR=$(find "$SEARCH_BASE" -type d -path "*/Debug/*.app" -print -quit || true)
            fi
          fi
          if [ -z "$APP_DIR" ]; then
            echo "::error::No simulator .app found under $SEARCH_BASE"
            find "$DERIVED_DATA" -maxdepth 5 -type d -name "*.app" || true
            exit 1
          fi
          echo "Found simulator build at $APP_DIR"
          echo "APP_DIR=$APP_DIR" >> $GITHUB_ENV

      - name: Take simulator screenshots (Run-C)
        run: |
          set -euo pipefail
          mkdir -p sim_screenshots
          DEVICE_NAME='${{ inputs.device }}'
          UDID=$(xcrun simctl list devices | grep -F "${DEVICE_NAME}" | head -n1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' || true)
          if [ -z "$UDID" ]; then echo "::error::Device not found: $DEVICE_NAME"; xcrun simctl list devices; exit 1; fi
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b
          xcrun simctl install "$UDID" "$APP_DIR"
          BUNDLE_ID="com.murugan.guha"
          # 1) Launch default editor screen
          xcrun simctl terminate "$UDID" "$BUNDLE_ID" || true
          xcrun simctl launch "$UDID" "$BUNDLE_ID" --disable-animations --auto-run || true
          sleep 3
          xcrun simctl io "$UDID" screenshot "sim_screenshots/01_editor.png"

          # 2) Optionally re-launch to ensure clean state, then capture "after run" output
          xcrun simctl terminate "$UDID" "$BUNDLE_ID" || true
          xcrun simctl launch "$UDID" "$BUNDLE_ID" --disable-animations --auto-run || true
          sleep 3
          xcrun simctl io "$UDID" screenshot "sim_screenshots/02_after_run.png"

      - name: Ensure ImageMagick is installed
        run: |
          set -euo pipefail
          if ! command -v magick >/dev/null 2>&1; then
            brew update
            brew install imagemagick
          fi
          magick -version

      - name: Normalize to 1284x2778 (Apple-accepted)
        run: |
          set -euo pipefail
          mkdir -p sim_screenshots/final
          if command -v magick >/dev/null 2>&1; then
            shopt -s nullglob
            for f in sim_screenshots/*.png; do
              base=$(basename "${f%.*}")
              out="sim_screenshots/final/${base}_1284x2778.png"
              magick "$f" -resize "1284x2778^" -gravity center -crop 1284x2778+0+0 +repage "$out"
              echo "Wrote $out"
            done
          else
            echo "::warning ::ImageMagick not found; skipping normalization to 1284x2778"
          fi

      - name: Validate final image dimensions (require 1284x2778)
        run: |
          set -euo pipefail
          if ! command -v magick >/dev/null 2>&1; then
            echo "::error ::ImageMagick is required for validation"
            exit 1
          fi
          shopt -s nullglob
          any=0
          failed=0
          for f in sim_screenshots/final/*.png; do
            any=1
            dims=$(magick identify -format "%w %h" "$f" || true)
            w=$(echo "$dims" | awk '{print $1}')
            h=$(echo "$dims" | awk '{print $2}')
            echo "Validate: $f -> ${w}x${h}"
            if [ "$w" != "1284" ] || [ "$h" != "2778" ]; then
              echo "::error file=$f::Expected 1284x2778 but got ${w}x${h}"
              failed=1
            fi
          done
          if [ "$any" = "0" ]; then
            echo "::error ::No files found in sim_screenshots/final to validate"
            exit 1
          fi
          if [ "$failed" = "1" ]; then
            exit 1
          fi

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Run-C-iPhone-Screenshots
          path: |
            sim_screenshots/final/*.png
            sim_screenshots/*.png
