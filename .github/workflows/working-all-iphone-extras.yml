name: Run-C Screenshots (iPhone Extras)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Simulator device name (iPhone)"
        required: false
        default: "iPhone 16 Pro"

jobs:
  simshot:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build app for Simulator (Debug)
        run: |
          set -euo pipefail
          DEVICE_NAME='${{ inputs.device }}'
          xcodebuild -resolvePackageDependencies -project Run-C.xcodeproj -scheme "Run-C" -clonedSourcePackagesDirPath "$RUNNER_TEMP/SPM"
          xcodebuild -project Run-C.xcodeproj \
            -scheme "Run-C" \
            -configuration Debug \
            -destination "platform=iOS Simulator,name=${DEVICE_NAME},OS=latest" \
            -derivedDataPath "$RUNNER_TEMP/DerivedData" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=YES ARCHS=arm64 EXCLUDED_ARCHS=arm64e \
            IPHONEOS_DEPLOYMENT_TARGET=17.0 \
            build | xcpretty
          APP_DIR=$(find "$RUNNER_TEMP/DerivedData/Build/Products/Debug-iphonesimulator" -type d -name "*.app" -maxdepth 1 | head -n1 || true)
          if [ -z "$APP_DIR" ]; then echo "::error::No simulator .app found"; exit 1; fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_ENV

      - name: Take simulator screenshots (Programs & Warnings)
        run: |
          set -euo pipefail
          mkdir -p sim_screenshots
          DEVICE_NAME='${{ inputs.device }}'
          UDID=$(xcrun simctl list devices | grep -F "${DEVICE_NAME}" | head -n1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/' || true)
          if [ -z "$UDID" ]; then echo "::error::Device not found: $DEVICE_NAME"; xcrun simctl list devices; exit 1; fi
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b
          xcrun simctl install "$UDID" "$APP_DIR"
          BUNDLE_ID="com.murugan.guha"

          # Light mode: Programs sheet
          xcrun simctl ui "$UDID" appearance light || true
          xcrun simctl terminate "$UDID" "$BUNDLE_ID" || true
          xcrun simctl launch "$UDID" "$BUNDLE_ID" --disable-animations --auto-run --scenario=programs || true
          sleep 3
          xcrun simctl io "$UDID" screenshot "sim_screenshots/01_programs.png"

          # Dark mode: warnings console
          xcrun simctl ui "$UDID" appearance dark || true
          xcrun simctl terminate "$UDID" "$BUNDLE_ID" || true
          xcrun simctl launch "$UDID" "$BUNDLE_ID" --disable-animations --auto-run --scenario=warnings || true
          sleep 3
          xcrun simctl io "$UDID" screenshot "sim_screenshots/02_warnings.png"

          # Reset appearance for any follow-up automation
          xcrun simctl ui "$UDID" appearance unspecified || true

      - name: Ensure ImageMagick is installed
        run: |
          set -euo pipefail
          if ! command -v magick >/dev/null 2>&1; then
            brew update
            brew install imagemagick
          fi
          magick -version

      - name: Normalize to 1242x2688 (Apple-accepted)
        run: |
          set -euo pipefail
          mkdir -p sim_screenshots/final
          if command -v magick >/dev/null 2>&1; then
            shopt -s nullglob
            for f in sim_screenshots/*.png; do
              base=$(basename "${f%.*}")
              out="sim_screenshots/final/${base}_1242x2688.png"
              magick "$f" -resize "1242x2688^" -gravity center -crop 1242x2688+0+0 +repage "$out"
              echo "Wrote $out"
            done
          else
            echo "::warning ::ImageMagick not found; skipping normalization to 1242x2688"
          fi

      - name: Validate final image dimensions (require 1242x2688)
        run: |
          set -euo pipefail
          if ! command -v magick >/dev/null 2>&1; then
            echo "::error ::ImageMagick is required for validation"
            exit 1
          fi
          shopt -s nullglob
          any=0
          failed=0
          for f in sim_screenshots/final/*.png; do
            any=1
            dims=$(magick identify -format "%w %h" "$f" || true)
            w=$(echo "$dims" | awk '{print $1}')
            h=$(echo "$dims" | awk '{print $2}')
            echo "Validate: $f -> ${w}x${h}"
            if [ "$w" != "1242" ] || [ "$h" != "2688" ]; then
              echo "::error file=$f::Expected 1242x2688 but got ${w}x${h}"
              failed=1
            fi
          done
          if [ "$any" = "0" ]; then
            echo "::error ::No files found in sim_screenshots/final to validate"
            exit 1
          fi
          if [ "$failed" = "1" ]; then
            exit 1
          fi

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Run-C-iPhone-Screenshots-Extras
          path: |
            sim_screenshots/final/*.png
            sim_screenshots/*.png
